import{r as h,j as s,$ as Ie,R as ke,a as We}from"./vendor-CRIxBkTT.js";import{L as f,N as Ue,G as ie,P as Ee,c as xe,B as Pe,C as fe}from"./gameUtils-C3kaCte8.js";import{c as ze,N as Xe}from"./gameSystems-Bqbpn00y.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const w of document.querySelectorAll('link[rel="modulepreload"]'))y(w);new MutationObserver(w=>{for(const E of w)if(E.type==="childList")for(const R of E.addedNodes)R.tagName==="LINK"&&R.rel==="modulepreload"&&y(R)}).observe(document,{childList:!0,subtree:!0});function u(w){const E={};return w.integrity&&(E.integrity=w.integrity),w.referrerPolicy&&(E.referrerPolicy=w.referrerPolicy),w.crossOrigin==="use-credentials"?E.credentials="include":w.crossOrigin==="anonymous"?E.credentials="omit":E.credentials="same-origin",E}function y(w){if(w.ep)return;w.ep=!0;const E=u(w);fetch(w.href,E)}})();const $e=({state:G,onRespawn:o,onNewGame:u,isPaused:y=!1,globalPaused:w=!1,isMultiplayer:E=!1,isHost:R=!1,connectionStatus:i="disconnected",onBackToMenu:v,onNameChange:ae,localPlayerName:H="Player",localPlayerId:q="",connectedPlayers:j=[],playerScores:me=new Map})=>{const{player:X,score:C,gameOver:k,gameStartTime:V,gameDuration:$,gameEnded:D}=G,[Z,se]=h.useState(10),[ve,le]=h.useState(!1),[de,he]=h.useState(H),[pe,ue]=h.useState(300);h.useEffect(()=>{he(H)},[H]),h.useEffect(()=>{if(!V||k||D)return;const L=()=>{const x=Date.now()-V,M=Math.max(0,Math.ceil(($-x)/1e3));ue(M)};L();const O=setInterval(L,1e3);return()=>clearInterval(O)},[V,$,k,D]),h.useEffect(()=>{let L;return k?(se(10),L=setInterval(()=>{se(O=>Math.max(0,O-1))},1e3)):se(10),()=>clearInterval(L)},[k]);const K=h.useCallback(()=>{const L=de.trim().slice(0,15)||"Player";he(L),le(!1),ae==null||ae(L)},[de,ae]),ee=h.useCallback(L=>{L.key==="Enter"?K():L.key==="Escape"&&(he(H),le(!1))},[K,H]),B=(L,O)=>{const x=X.limbs[L],M=Math.max(0,x.hp/x.maxHp*100),W=x.exists?M>50?"bg-cyan-500":"bg-orange-500":"bg-red-900 opacity-50";return s.jsxs("div",{className:"mb-1.5",children:[s.jsxs("div",{className:"flex justify-between text-[9px] uppercase font-bold text-gray-400 mb-0.5",children:[s.jsx("span",{children:O}),s.jsx("span",{children:`${Math.max(0,Math.round(x.hp))}/${x.maxHp}`})]}),s.jsx("div",{className:"w-full h-1.5 bg-gray-800 rounded-full overflow-hidden",children:s.jsx("div",{className:`h-full transition-all duration-300 ${W}`,style:{width:`${M}%`}})})]},L)};[f.LEFT_ARM,f.RIGHT_ARM,f.LEFT_LEG,f.RIGHT_LEG].filter(L=>X.limbs[L].exists).length;const Te=()=>{switch(i){case"connecting":return"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...";case"connected":return"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾";case"error":return"ÐžÑˆÐ¸Ð±ÐºÐ°";default:return"ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾"}},be=()=>{switch(i){case"connecting":return"text-yellow-400";case"connected":return"text-green-400";case"error":return"text-red-400";default:return"text-gray-400"}},F=L=>{const O=Math.floor(L/60),x=L%60;return`${O}:${x.toString().padStart(2,"0")}`},Le=y||w;return s.jsxs("div",{className:"absolute inset-0 pointer-events-none flex flex-col justify-between p-6",children:[s.jsxs("div",{className:"self-center flex flex-col items-center gap-2",children:[!D&&!k&&s.jsxs("div",{className:"bg-black/40 px-6 py-2 rounded-full border border-white/10 backdrop-blur-sm flex items-center gap-4",children:[s.jsx("span",{className:`font-mono text-lg tracking-widest ${pe<=60?"text-red-400 animate-pulse":"text-yellow-400"}`,children:F(pe)}),s.jsx("span",{className:"text-white/30",children:"|"}),s.jsx("span",{className:"text-cyan-500 font-mono text-xl tracking-widest",children:C.toString().padStart(6,"0")})]}),E&&s.jsxs("div",{className:`bg-black/40 border border-white/10 px-4 py-1 rounded text-[10px] uppercase font-black backdrop-blur-sm tracking-widest ${be()}`,children:[Te()," ",j.length>0&&`(${j.length}/4)`]})]}),E&&j.length>0&&s.jsx("div",{className:"absolute top-6 right-6 bg-black/60 border border-white/10 rounded-lg p-3 backdrop-blur-md",children:j.map(L=>s.jsxs("div",{className:"flex items-center gap-2 mb-1 last:mb-0",children:[s.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:L.color,boxShadow:`0 0 8px ${L.color}`}}),s.jsx("span",{className:"text-white text-xs font-mono",children:L.name})]},L.id))}),s.jsxs("div",{className:"w-72 bg-black/60 border border-white/10 p-5 rounded-lg backdrop-blur-md",children:[s.jsx("h3",{className:"text-white text-[11px] font-black uppercase tracking-[0.2em] mb-2 border-b border-white/10 pb-1.5",children:"Unit Vital Systems"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4",children:[B(f.HEAD,"Brain Matrix"),B(f.TORSO,"Core")]}),s.jsx("div",{className:"mt-1.5 pt-2 border-t border-white/5",children:s.jsxs("div",{className:"grid grid-cols-2 gap-x-4",children:[s.jsxs("div",{children:[B(f.LEFT_ARM,"L-Manipulator"),B(f.LEFT_LEG,"L-Actuator")]}),s.jsxs("div",{children:[B(f.RIGHT_ARM,"R-Manipulator"),B(f.RIGHT_LEG,"R-Actuator")]})]})})]}),Le&&!k&&s.jsx("div",{className:"absolute inset-0 bg-black/80 pointer-events-auto flex items-center justify-center backdrop-blur-xl",children:s.jsxs("div",{className:"text-center p-12 border-2 border-cyan-500/30 rounded-2xl bg-black/40",children:[s.jsx("h1",{className:"text-5xl font-black text-white italic tracking-tighter mb-4",children:w?"PAUSED (Host)":"PAUSED"}),s.jsx("div",{className:"mb-6",children:ve?s.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s.jsx("input",{type:"text",value:de,onChange:L=>he(L.target.value.slice(0,15)),onKeyPress:ee,maxLength:15,className:"px-4 py-2 bg-black/50 border-2 border-cyan-500/50 rounded-lg text-white text-center font-mono focus:border-cyan-500 focus:outline-none",autoFocus:!0}),s.jsx("button",{onClick:K,className:"px-4 py-2 bg-cyan-500 text-black font-bold uppercase rounded hover:bg-cyan-400",children:"âœ“"})]}):s.jsxs("button",{onClick:()=>le(!0),className:"text-cyan-400 hover:text-cyan-300 text-sm font-mono underline decoration-dashed",children:[H," âœ"]})}),s.jsxs("div",{className:"flex flex-col gap-3",children:[R&&s.jsx("p",{className:"text-yellow-400 text-sm",children:"Ð’Ñ‹ Ñ…Ð¾ÑÑ‚ â€” Ð¿Ð°ÑƒÐ·Ð° Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ ÐºÐ¾ Ð²ÑÐµÐ¼ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼"}),!R&&w&&s.jsx("p",{className:"text-gray-400 text-sm",children:"Ð¥Ð¾ÑÑ‚ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð¸Ð³Ñ€Ñƒ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ"}),s.jsx("button",{onClick:()=>v==null?void 0:v(),className:"px-10 py-4 font-bold uppercase tracking-widest transition-all transform hover:scale-105 active:scale-95 bg-white/10 text-white hover:bg-white/20 border border-white/20 rounded-lg",children:"Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ"})]}),s.jsx("p",{className:"mt-6 text-gray-400 text-sm",children:R?"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ESC Ð¸Ð»Ð¸ P Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ":"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ Ñ…Ð¾ÑÑ‚Ð¾Ð¼..."})]})}),D&&s.jsx("div",{className:"absolute inset-0 bg-black/90 pointer-events-auto flex items-center justify-center backdrop-blur-xl",children:s.jsxs("div",{className:"text-center p-12 border-4 border-yellow-500/30 rounded-2xl bg-black/40 max-w-2xl",children:[s.jsx("h1",{className:"text-6xl font-black text-yellow-400 italic tracking-tighter mb-2",children:"TIME'S UP!"}),s.jsx("p",{className:"text-xl text-white/80 uppercase tracking-[0.3em] mb-8",children:"Final Rankings"}),s.jsx("div",{className:"mb-8",children:(()=>{const L=[{name:H,score:C,isLocal:!0,color:"#00f2ff"}];j.forEach(x=>{x.id!==q&&L.push({name:x.name,score:me.get(x.id)||0,isLocal:!1,color:x.color})}),L.sort((x,M)=>M.score-x.score);const O=x=>{switch(x){case 1:return"ðŸ¥‡";case 2:return"ðŸ¥ˆ";case 3:return"ðŸ¥‰";default:return`#${x}`}};return L.map((x,M)=>s.jsxs("div",{className:`flex items-center justify-between px-6 py-3 mb-2 rounded-lg ${x.isLocal?"bg-cyan-500/20 border border-cyan-500/30":"bg-white/5"}`,children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx("span",{className:"text-2xl",children:O(M+1)}),s.jsx("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:x.color,boxShadow:`0 0 10px ${x.color}`}}),s.jsxs("span",{className:`text-lg font-bold ${x.isLocal?"text-cyan-400":"text-white"}`,children:[x.name,x.isLocal&&s.jsx("span",{className:"text-xs text-cyan-500 ml-2",children:"(YOU)"})]})]}),s.jsx("span",{className:"text-xl font-mono text-yellow-400",children:x.score.toString().padStart(6,"0")})]},M))})()}),s.jsxs("div",{className:"flex gap-4 justify-center",children:[s.jsx("button",{onClick:u,className:"px-12 py-5 font-bold uppercase tracking-widest transition-all transform hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(6,182,212,0.5)] bg-cyan-500 text-black hover:bg-white",children:"Play Again"}),s.jsx("button",{onClick:()=>v==null?void 0:v(),className:"px-12 py-5 font-bold uppercase tracking-widest transition-all transform hover:scale-105 active:scale-95 bg-white/10 text-white hover:bg-white/20 border border-white/20 rounded-lg",children:"Main Menu"})]})]})}),k&&!D&&s.jsx("div",{className:"absolute inset-0 bg-red-950/85 pointer-events-auto flex items-center justify-center backdrop-blur-xl",children:s.jsxs("div",{className:"text-center p-12 border-4 border-red-500/30 rounded-2xl bg-black/40",children:[s.jsx("h1",{className:"text-7xl font-black text-white italic tracking-tighter mb-2 animate-pulse",children:"UNIT DESTROYED"}),s.jsx("p",{className:"text-xl text-red-400 uppercase tracking-[0.3em] mb-10",children:"Critical Component Failure"}),Z>0?s.jsxs("div",{className:"text-cyan-400 font-mono text-2xl tracking-[0.5em] mb-4",children:["RE-INITIALIZING IN: ",Z,"s"]}):null,s.jsxs("div",{className:"flex gap-4 justify-center",children:[s.jsx("button",{disabled:Z>0,onClick:o,className:`px-12 py-5 font-bold uppercase tracking-widest transition-all transform hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(6,182,212,0.5)] ${Z>0?"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50":"bg-cyan-500 text-black hover:bg-white"}`,children:"System Re-Initialize"}),s.jsx("button",{onClick:()=>v==null?void 0:v(),className:"px-12 py-5 font-bold uppercase tracking-widest transition-all transform hover:scale-105 active:scale-95 bg-white/10 text-white hover:bg-white/20 border border-white/20 rounded-lg",children:"Main Menu"})]})]})})]})},Je=({gameMode:G,isPaused:o,globalPaused:u,onPauseToggle:y,onRestart:w,onBackToMenu:E,onNameChange:R,webrtcManager:i,localPlayerId:v,localPlayerName:ae})=>{const H=h.useRef(null),q=h.useRef(0),j=h.useRef({}),me=h.useRef({}),X=h.useRef({x:0,y:0,left:!1,right:!1}),C=h.useRef(new Map),[k,V]=h.useState("disconnected"),[$,D]=h.useState([]),Z=h.useRef(0),se=h.useRef(0),ve=h.useRef(""),le=h.useRef(null),de=h.useRef(new Map),[he,pe]=h.useState(!1),ue=h.useRef(new Map);h.useRef(ze()),h.useRef(new Xe(Ue)),h.useRef(null);const K=G===ie.MULTI_PLAYER,ee=(i==null?void 0:i.isHostMode())??!1,B=h.useCallback(()=>Ee[0],[]),ye=[{x:-500,y:500,width:3e3,height:60},{x:300,y:400,width:250,height:25},{x:700,y:320,width:250,height:25},{x:150,y:220,width:200,height:25},{x:1e3,y:420,width:300,height:25},{x:400,y:100,width:200,height:25},{x:800,y:0,width:250,height:25},{x:1200,y:-80,width:200,height:25},{x:1500,y:-200,width:300,height:30},{x:1100,y:-350,width:200,height:25},{x:700,y:-450,width:250,height:25},{x:300,y:-600,width:200,height:25},{x:0,y:-750,width:250,height:25},{x:400,y:-900,width:300,height:30},{x:900,y:-1050,width:200,height:25},{x:1300,y:-1200,width:250,height:25},{x:1e3,y:-1400,width:150,height:25},{x:600,y:-1550,width:150,height:25},{x:200,y:-1700,width:150,height:25},{x:500,y:-1900,width:400,height:40},{x:1e3,y:-2100,width:200,height:25},{x:1400,y:-2300,width:250,height:25},{x:800,y:-2500,width:500,height:50}].map(e=>e.y<500?{...e,x:e.x*.9,y:e.y*.9}:e),Te=()=>ye.reduce((e,n)=>n.y<e.y?n:e),be=()=>{const e=Te();return{x:e.x+e.width/2-10,y:e.y-30,collected:!1}},F=h.useRef({player:xe(100,300),enemies:[],projectiles:[],platforms:ye,vfx:[],camera:{x:0,y:0},score:0,gameOver:!1,detachedLimbs:[],star:be(),gameStartTime:Date.now(),gameDuration:3e5,gameEnded:!1}),[Le,L]=h.useState(F.current);h.useEffect(()=>{if(!i)return;const e=n=>{const t=F.current;switch(n.type){case"PLAYER_UPDATE":{const{id:d,x:l,y:m,vx:b,vy:r,facing:g,limbs:S,onGround:T,score:N}=n.data,_=C.current.get(d);if(N!==void 0&&ue.current.set(d,N),_)_.x=l,_.y=m,_.vx=b,_.vy=r,_.facing=g,T!==void 0&&(_.onGround=T),S&&Object.entries(S).forEach(([Y,ne])=>{_.limbs[Y]&&(_.limbs[Y]=ne)});else{const Y={...xe(100,300),id:d,color:Ee[Math.min($.length,3)],x:l,y:m,vx:b,vy:r,facing:g,limbs:S||xe(100,300).limbs};T!==void 0&&(Y.onGround=T),C.current.set(d,Y)}break}case"PLAYER_SHOT":{const{x:d,y:l,angle:m,color:b}=n.data,r=Math.cos(m)*Pe,g=Math.sin(m)*Pe;t.projectiles.push({x:d,y:l,vx:r,vy:g,width:8,height:8,owner:"REMOTE_PLAYER",ownerId:n.playerId,damage:10,color:b});break}case"PLAYER_DIED":{const{id:d,score:l}=n.data;l!==void 0&&ue.current.set(d,l),C.current.delete(d);break}case"PLAYER_DISCONNECTED":{const{id:d}=n.data;C.current.delete(d);break}case"PLAYER_JOINED":{const{id:d,color:l}=n.data;if(!C.current.has(d)){const m={...xe(100,300),id:d,color:l||Ee[1],x:100,y:300,vx:0,vy:0,facing:0,limbs:xe(100,300).limbs};C.current.set(d,m)}break}case"PAUSE_TOGGLE":{const{paused:d}=n.data;pe(d);break}case"PLAYER_DAMAGE":{const{targetId:d,limbKey:l,damage:m}=n.data;if(d===v){const b=t.player.limbs[l];b&&b.exists&&(b.hp-=m,b.damageFlashTimer=10,t.player.stunTimer=12,b.hp<=0&&(b.exists=!1,(l===f.TORSO||l===f.HEAD)&&(t.gameOver=!0)))}break}case"LIMB_DETACHED":{const{playerId:d,limbType:l,x:m,y:b,vx:r,vy:g,color:S,hp:T,maxHp:N,destroyed:_}=n.data,Y=C.current.get(d);Y&&(Y.limbs[l].exists=!1,t.detachedLimbs.push({limbType:l,x:m,y:b,vx:r,vy:g,width:l.includes("ARM")?28:25,height:l.includes("ARM")?12:10,color:S,rotation:0,rotationSpeed:(Math.random()-.5)*.3,owner:"REMOTE_PLAYER",ownerId:d,hp:T||50,maxHp:N||(l.includes("ARM")?50:75),destroyed:_||!1}));break}case"LIMB_ATTACHED":{const{playerId:d,limbType:l,side:m,hp:b,maxHp:r}=n.data;if(d===v){const g=m==="left"?f.LEFT_ARM:f.RIGHT_ARM,S=t.player.limbs[g];S.exists=!0,S.hp=b,S.maxHp=r}else{const g=C.current.get(d);if(g){const S=m==="left"?f.LEFT_ARM:f.RIGHT_ARM,T=g.limbs[S];T.exists=!0,T.hp=b,T.maxHp=r}}break}case"GAME_START":{const d=t.platforms[0],l=d.x+100+Math.random()*(d.width-200),m=d.y-100;t.player=xe(l,m),t.player.x=l,t.player.y=m,t.enemies=[],t.projectiles=[],t.vfx=[],t.detachedLimbs=[],t.score=0,t.gameOver=!1,t.gameEnded=!1,t.gameStartTime=Date.now(),t.star=be(),t.camera={x:l-window.innerWidth/2,y:m-window.innerHeight/2},L({...t});break}case"ENEMY_SYNC":{if(!ee){const{enemies:d}=n.data,l=new Map,m=Date.now(),b=de.current;t.enemies.forEach(g=>{g.id&&l.set(g.id,g)}),d.forEach(g=>{const S=l.get(g.id);if(S)b.set(g.id,{targetX:g.x,targetY:g.y,startTime:m,startX:S.x,startY:S.y}),S.hp=g.hp;else{const T={x:g.x,y:g.y,width:35,height:35,vx:0,vy:0,hp:g.hp,type:"DRONE",lastFired:0,fireRate:1500+Math.random()*1e3,id:g.id};t.enemies.push(T)}});const r=new Set(d.map(g=>g.id));t.enemies=t.enemies.filter(g=>!g.id||r.has(g.id)),Array.from(b.keys()).forEach(g=>{r.has(g)||b.delete(g)})}break}case"STAR_COLLECTED":{const{score:d}=n.data;t.star.collected=!0,t.star.respawnTime=Date.now()+2e4+Math.random()*1e4;break}case"GAME_END":{t.gameEnded=!0;break}}};return i.onMessage(e),()=>{i.offMessage(e)}},[i,$.length,ee]),h.useEffect(()=>{if(!i)return;const e=n=>{V(n)};return i.onStatusChange(e),()=>{}},[i]),h.useEffect(()=>{G===ie.MULTI_PLAYER&&i&&(i.onPlayerListChange(e=>{D(e)}),D(i.getConnectedPlayers()))},[G,i]);const O=(e,n,t,d=15)=>{F.current.vfx.push({x:e,y:n,color:t,size:d,life:8,maxLife:8})},x=()=>{const e=F.current,n=H.current;if(!n)return;const t=150,d=Math.floor(Math.random()*3);let l=0,m=0;d===0?(l=e.camera.x-t,m=e.camera.y+Math.random()*n.height):d===1?(l=e.camera.x+n.width+t,m=e.camera.y+Math.random()*n.height):(l=e.camera.x+Math.random()*n.width,m=e.camera.y-t);const r={id:`enemy_${se.current++}_${Date.now()}`,x:l,y:m,width:35,height:35,vx:0,vy:0,hp:30,type:"DRONE",lastFired:0,fireRate:1500+Math.random()*1e3};e.enemies.push(r)},M=h.useCallback(()=>{if(!i||!i.isConnected())return;const e=Date.now();if(e-Z.current<50)return;Z.current=e;const n=F.current.player,t=i.getPeerId(),d=Object.values(n.limbs).some(m=>!m.exists||m.hp<m.maxHp);let l;if(d){const m=JSON.stringify(n.limbs);m!==ve.current&&(ve.current=m,l=n.limbs)}i.send({type:"PLAYER_UPDATE",playerId:t,data:{x:n.x,y:n.y,vx:n.vx,vy:n.vy,facing:n.facing,onGround:n.onGround,limbs:l,score:F.current.score},timestamp:e})},[i]),W=h.useRef(0),U=h.useCallback(()=>{if(!(i!=null&&i.isConnected())||!ee)return;const e=Date.now();if(e-W.current<500)return;W.current=e;const n=F.current,t=i.getPeerId(),d=n.enemies.map(l=>({id:l.id,x:l.x,y:l.y,hp:l.hp}));i.send({type:"ENEMY_SYNC",playerId:t,data:{enemies:d},timestamp:e})},[i,ee]),ge=h.useCallback((e,n,t,d)=>{if(!(i!=null&&i.isConnected()))return;const l=i.getPeerId();i.send({type:"PLAYER_SHOT",playerId:l,data:{x:e,y:n,angle:t,color:d},timestamp:Date.now()})},[i]),we=(e,n,t,d)=>{const l=t.x+t.width/2,m=t.y+t.height/2-5,b=m+10,r=d?j.current.KeyS||j.current.ArrowDown:!1,g=r?t.height*.2:0,S=r?8:0,T=!t.limbs.LEFT_LEG.exists&&!t.limbs.RIGHT_LEG.exists,N=T?15:0,_=[];if(t.limbs[f.LEFT_LEG].exists){const I=Date.now()/120,z=Math.abs(t.vx)>.5?Math.sin(I)*.6:0,a=t.onGround===!1?t.vy<0?-.4:.4:0,c=Math.PI/2+z+a,p=l-8+Math.cos(c)*25,P=b+N+Math.sin(c)*25;_.push({limb:f.LEFT_LEG,x:Math.min(l-8,p)-5,y:Math.min(b+N,P)-5,w:Math.abs(p-(l-8))+10,h:Math.abs(P-(b+N))+10})}if(t.limbs[f.RIGHT_LEG].exists){const I=Date.now()/120,z=Math.abs(t.vx)>.5?Math.sin(I)*.6:0,a=t.onGround===!1?t.vy<0?-.4:.4:0,c=Math.PI/2-z+a,p=l+8+Math.cos(c)*25,P=b+N+Math.sin(c)*25;_.push({limb:f.RIGHT_LEG,x:Math.min(l+8,p)-5,y:Math.min(b+N,P)-5,w:Math.abs(p-(l+8))+10,h:Math.abs(P-(b+N))+10})}const Y=T?N*.3:0;if(t.limbs[f.LEFT_ARM].exists){const I=l-15+Math.cos(t.facing)*28,z=m-7+Y+Math.sin(t.facing)*28;_.push({limb:f.LEFT_ARM,x:Math.min(l-15,I)-6,y:Math.min(m-7+Y,z)-6,w:Math.abs(I-(l-15))+12,h:Math.abs(z-(m-7+Y))+12})}if(t.limbs[f.RIGHT_ARM].exists){const I=l+15+Math.cos(t.facing)*28,z=m-7+Y+Math.sin(t.facing)*28;_.push({limb:f.RIGHT_ARM,x:Math.min(l+15,I)-6,y:Math.min(m-7+Y,z)-6,w:Math.abs(I-(l+15))+12,h:Math.abs(z-(m-7+Y))+12})}for(const I of _)if(e>=I.x&&e<=I.x+I.w&&n>=I.y&&n<=I.y+I.h)return I.limb;const ne=T?N:0;if(t.limbs[f.TORSO].exists){const I=l-18,z=m-18+g+ne;if(e>=I&&e<=I+36&&n>=z&&n<=z+36)return f.TORSO}if(t.limbs[f.HEAD].exists){const I=m-32+S+ne;if(e>=l-10&&e<=l+10&&n>=I&&n<=I+16)return f.HEAD}return null},Se=(e,n,t,d,l=!1)=>{const m=F.current,b=n.x+n.width/2,r=n.y+n.height/2-5,g=n.limbs[e];m.detachedLimbs.push({limbType:e,x:b,y:r-10,vx:(Math.random()-.5)*5,vy:-3-Math.random()*3,width:e.includes("ARM")?28:25,height:e.includes("ARM")?12:10,color:d,rotation:0,rotationSpeed:(Math.random()-.5)*.3,owner:t,ownerId:void 0,hp:Math.max(0,g.hp),maxHp:g.maxHp,destroyed:l,destroyTime:l?Date.now()+500:void 0}),l&&O(b,r-10,"#ffffff",30),i!=null&&i.isConnected()&&i.send({type:"LIMB_DETACHED",playerId:v,data:{limbType:e,x:b,y:r-10,vx:(Math.random()-.5)*5,vy:-3-Math.random()*3,color:d,hp:Math.max(0,g.hp),maxHp:g.maxHp,destroyed:l},timestamp:Date.now()})},Ge=e=>{const n=F.current,t=n.player,d=t.x+t.width/2,l=t.y+t.height/2;for(let m=n.detachedLimbs.length-1;m>=0;m--){const b=n.detachedLimbs[m],r=b.x+b.width/2,g=b.y+b.height/2;if(Math.sqrt((d-r)**2+(l-g)**2)<80){if(b.destroyed){O(r,g,"#ff4444",10);return}const T=b.limbType.includes("ARM");let N;T?N=e==="left"?f.LEFT_ARM:f.RIGHT_ARM:N=e==="left"?f.LEFT_LEG:f.RIGHT_LEG,t.limbs[N].exists=!0,t.limbs[N].hp=b.hp,t.limbs[N].maxHp=b.maxHp,n.detachedLimbs.splice(m,1),i!=null&&i.isConnected()&&i.send({type:"LIMB_ATTACHED",playerId:v,data:{limbType:N,side:e,hp:b.hp,maxHp:b.maxHp},timestamp:Date.now()}),O(r,g,"#ffffff",20);return}}},Ne=(e,n,t,d)=>{const l=F.current;if(Math.random()>=.05)return;const m=Math.random()<.5,b=m?f.LEFT_ARM:f.LEFT_LEG,r=m?ARM_MAX_HP:LEG_MAX_HP;l.detachedLimbs.push({limbType:b,x:e+t/2,y:n+d/2,vx:(Math.random()-.5)*4,vy:-2-Math.random()*2,width:m?28:25,height:m?12:10,color:m?fe.ARM:fe.LEG,rotation:0,rotationSpeed:(Math.random()-.5)*.2,owner:"PLAYER",hp:r,maxHp:r})},He=()=>{const e=F.current,n=ye[Math.floor(Math.random()*ye.length)];e.star={x:n.x+n.width/2-10,y:n.y-30,collected:!1}},De=()=>{var ne,I,z;const e=F.current;if(!e.gameEnded&&e.gameStartTime&&Date.now()-e.gameStartTime>=e.gameDuration&&(e.gameEnded=!0,i!=null&&i.isConnected()&&i.send({type:"GAME_END",playerId:v,data:{score:e.score},timestamp:Date.now()})),o||u||he||e.gameOver||e.gameEnded)return;const t=e.player;t.stunTimer>0&&t.stunTimer--;const d=j.current.KeyS||j.current.ArrowDown,l=t.stunTimer>0?.5:1,m=[t.limbs.LEFT_LEG.exists,t.limbs.RIGHT_LEG.exists].filter(Boolean).length,b=m===0;let r=(d?.4:1)*l;m===1&&(r*=.5),b&&(r*=.15);let g=0;j.current.KeyA&&(g=-1),j.current.KeyD&&(g=1);const S=Date.now();if(g!==0){t.lastMoveDir!==g&&(t.moveStartTime=S,t.lastMoveDir=g);const a=S-(t.moveStartTime||S),c=Math.min(1,a/ACCELERATION_TIME),p=PLAYER_SPEED*c*r;t.vx+=g*p*.2}else t.lastMoveDir=0,t.moveStartTime=void 0;if(j.current.Space&&!me.current.Space&&t.onGround&&m>0&&(t.vy=PLAYER_JUMP*(t.stunTimer>0?.8:1),t.onGround=!1),me.current.Space=j.current.Space,b&&t.onGround&&Math.abs(t.vx)>.3&&Math.random()<.1&&(t.vy=-6,t.onGround=!1),t.vx*=FRICTION,t.vy+=GRAVITY,t.x+=t.vx,t.y+=t.vy,t.y>1500&&(e.score=Math.floor(e.score/2),e.gameOver=!0,t.limbs[f.TORSO].hp=0,t.limbs[f.TORSO].exists=!1,i!=null&&i.isConnected())){const a=i.getPeerId();i.send({type:"PLAYER_DIED",playerId:a,data:{id:a,score:e.score},timestamp:Date.now()})}if(t.onGround=!1,e.platforms.forEach(a=>{if(t.x+t.width>a.x&&t.x<a.x+a.width){const c=b?t.y+t.height*.6:t.y+t.height,p=b?t.height*.6:t.height;c>=a.y&&c<=a.y+a.height+Math.max(0,t.vy)+1&&t.vy>=0&&(t.y=a.y-p,t.vy=0,t.onGround=!0)}}),e.star.collected)e.star.respawnTime&&Date.now()>=e.star.respawnTime&&He();else{const a=e.star.x+10,c=e.star.y+10,p=t.x+t.width/2,P=t.y+t.height/2;Math.sqrt((a-p)**2+(c-P)**2)<40&&(e.score*=2,e.star.collected=!0,e.star.respawnTime=Date.now()+2e4+Math.random()*1e4,O(a,c,"#ffdd00",40),O(a,c,"#ffffff",30),i!=null&&i.isConnected()&&i.send({type:"STAR_COLLECTED",playerId:v,data:{score:e.score},timestamp:Date.now()}))}if(t.vy>0&&m>0)for(let a=e.enemies.length-1;a>=0;a--){const c=e.enemies[a];if(t.x+t.width>c.x&&t.x<c.x+c.width&&t.y+t.height>c.y&&t.y+t.height<c.y+c.height+t.vy){t.vy=PLAYER_JUMP/2,t.onGround=!0,c.hp-=20,O(t.x+t.width/2,t.y+t.height,"#ffffff",30),c.hp<=0&&(Ne(c.x,c.y,c.width,c.height),e.enemies.splice(a,1),e.score+=250);break}}let T=le.current;if((!T||T.width!==((ne=H.current)==null?void 0:ne.width)||T.height!==((I=H.current)==null?void 0:I.height))&&(T=((z=H.current)==null?void 0:z.getBoundingClientRect())||null,le.current=T),T){const a=X.current.x-T.left+e.camera.x,c=X.current.y-T.top+e.camera.y,p=t.y+t.height/2-12+(d?t.height*.2:0);t.facing=Math.atan2(c-p,a-(t.x+t.width/2));const P=Date.now(),A=Math.cos(t.facing),J=Math.sin(t.facing),te=A*Pe,oe=J*Pe;if(X.current.left&&t.limbs.LEFT_ARM.exists&&P-t.leftWeapon.lastFired>t.leftWeapon.cooldown){const Q=t.x+t.width/2-15+A*28,ce=p+J*28;e.projectiles.push({x:Q,y:ce,vx:te,vy:oe,width:8,height:8,owner:"PLAYER",damage:10,color:t.leftWeapon.color}),t.leftWeapon.lastFired=P,K&&ge(Q,ce,t.facing,t.leftWeapon.color)}if(X.current.right&&t.limbs.RIGHT_ARM.exists&&P-t.rightWeapon.lastFired>t.rightWeapon.cooldown){const Q=t.x+t.width/2+15+A*28,ce=p+J*28;e.projectiles.push({x:Q,y:ce,vx:te,vy:oe,width:8,height:8,owner:"PLAYER",damage:10,color:t.rightWeapon.color}),t.rightWeapon.lastFired=P,K&&ge(Q,ce,t.facing,t.rightWeapon.color)}}let N=e.score;if(K){const a=[e.score];C.current.forEach(c=>{a.push(ue.current.get(c.id)||0)}),N=a.reduce((c,p)=>c+p,0)/a.length}const _=G===ie.SINGLE_PLAYER?5+Math.floor(N/2e3):3+Math.floor(N/3e3);if(e.enemies.length<_&&Math.random()<.015&&x(),!ee&&K){const a=Date.now(),c=450;e.enemies.forEach(p=>{if(p.id){const P=de.current.get(p.id);if(P){const A=a-P.startTime;if(A<c){const J=A/c;p.x=P.startX+(P.targetX-P.startX)*J,p.y=P.startY+(P.targetY-P.startY)*J}else p.x=P.targetX,p.y=P.targetY,de.current.delete(p.id)}}})}e.enemies.forEach((a,c)=>{const p=[t];if(C.current.forEach(re=>{re.limbs[f.TORSO].exists&&p.push(re)}),!a.targetPlayerId||Math.random()<.01){const re=p[Math.floor(Math.random()*p.length)];a.targetPlayerId=re===t?"local":re.id}const P=a.targetPlayerId;let A=t;if(P!=="local"){const re=C.current.get(P);re&&re.limbs[f.TORSO].exists?A=re:A=t}const J=A.x+A.width/2-a.x,te=A.y+A.height/2-a.y,oe=Math.sqrt(J*J+te*te),Q=Math.atan2(te,J),ce=250+Math.sin(Date.now()/1e3+c)*50;if(!ee&&K&&a.id&&de.current.has(a.id)||(oe>ce+50?(a.vx+=Math.cos(Q)*.35,a.vy+=Math.sin(Q)*.35):oe<ce-50&&(a.vx-=Math.cos(Q)*.17,a.vy-=Math.sin(Q)*.17),a.vx*=.94,a.vy*=.94,a.x+=a.vx,a.y+=a.vy),Date.now()-a.lastFired>a.fireRate&&oe<800){const re=Object.values(A.limbs).filter(Ce=>Ce.exists).map(Ce=>Ce.type);e.projectiles.push({x:a.x+a.width/2,y:a.y+a.height/2,vx:Math.cos(Q)*8,vy:Math.sin(Q)*8,width:8,height:8,owner:"ENEMY",damage:8,color:fe.ENEMY,targetLimb:re[Math.floor(Math.random()*re.length)]}),a.lastFired=Date.now()}}),e.projectiles=e.projectiles.filter(a=>{if(a.x+=a.vx,a.y+=a.vy,Math.abs(a.x-t.x)>2e3)return!1;if(a.owner==="ENEMY"){const c=we(a.x,a.y,t,!0);if(c){const p=t.limbs[c];if(p.exists){let P=a.damage*(p.damageMultiplier||1);if(c===f.TORSO||c===f.HEAD){const A=[f.LEFT_ARM,f.RIGHT_ARM,f.LEFT_LEG,f.RIGHT_LEG].filter(J=>t.limbs[J].exists).length;P*=1-A*.15,O(a.x,a.y,fe.PLAYER,12)}else O(a.x,a.y,a.color,8);if(p.hp-=P,p.damageFlashTimer=10,t.stunTimer=12,t.vx+=a.vx*1.2,(c===f.LEFT_ARM||c===f.RIGHT_ARM||c===f.LEFT_LEG||c===f.RIGHT_LEG)&&Math.random()<.05&&p.hp>0){p.exists=!1;const A=c===f.LEFT_ARM||c===f.RIGHT_ARM?fe.ARM:fe.LEG;Se(c,t,"PLAYER",A,!1)}else if(p.hp<=0)if(p.exists=!1,c===f.TORSO||c===f.HEAD)e.score=Math.floor(e.score/2),e.gameOver=!0;else{const A=c===f.LEFT_ARM||c===f.RIGHT_ARM?fe.ARM:fe.LEG;Se(c,t,"PLAYER",A,!0)}}return!1}}else if(a.owner==="PLAYER"||a.owner==="REMOTE_PLAYER"){for(let c=e.enemies.length-1;c>=0;c--){const p=e.enemies[c];if(a.x>p.x&&a.x<p.x+p.width&&a.y>p.y&&a.y<p.y+p.height)return p.hp-=a.damage,O(a.x,a.y,a.color,20),p.hp<=0&&(Ne(p.x,p.y,p.width,p.height),e.enemies.splice(c,1),e.score+=150),!1}if(K)for(const[c,p]of C.current){let P;if(a.owner==="PLAYER")P=v;else if(a.owner==="REMOTE_PLAYER"){if(P=a.ownerId,!P)continue}else continue;if(P===c)continue;const A=we(a.x,a.y,p,!1);if(A){const J=p.limbs[A];if(J.exists){let te=a.damage*(J.damageMultiplier||1);if(A===f.TORSO||A===f.HEAD){const oe=[f.LEFT_ARM,f.RIGHT_ARM,f.LEFT_LEG,f.RIGHT_LEG].filter(Q=>p.limbs[Q].exists).length;te*=1-oe*.15}return J.hp-=te,J.damageFlashTimer=10,a.owner==="PLAYER"&&(i!=null&&i.isConnected())&&i.send({type:"PLAYER_DAMAGE",playerId:v,data:{targetId:c,limbKey:A,damage:te},timestamp:Date.now()}),O(a.x,a.y,a.color,15),!1}}}}return!0}),e.vfx=e.vfx.filter(a=>(a.life--,a.life>0)),e.detachedLimbs=e.detachedLimbs.filter(a=>{a.vy+=GRAVITY*.5,a.x+=a.vx,a.y+=a.vy,a.rotation+=a.rotationSpeed,a.vx*=.98;for(const c of e.platforms)a.x+a.width>c.x&&a.x<c.x+c.width&&a.y+a.height>=c.y&&a.y+a.height<=c.y+c.height+a.vy+1&&a.vy>0&&(a.y=c.y-a.height,a.vy=-a.vy*.3,a.vx*=.7,a.rotationSpeed*=.5);return a.destroyed&&a.destroyTime&&Date.now()>=a.destroyTime?(O(a.x+a.width/2,a.y+a.height/2,a.color,15),!1):a.y<2e3});const Y=H.current;Y&&(e.camera.x+=(t.x+t.vx*10-Y.width/2-e.camera.x)*.08,e.camera.y+=(t.y+t.vy*5-Y.height/2-e.camera.y)*.08),L({...e}),M(),U()},Ae=(e,n,t,d)=>{const l=d?j.current.KeyS||j.current.ArrowDown:!1,m=l?n.height*.2:0,b=l?8:0,r=n.x+n.width/2,g=n.y+n.height/2-5,S=g+10,T=(a,c,p,P,A,J,te)=>{if(!n.limbs[a].exists)return;const oe=n.limbs[a],ce=(oe.damageFlashTimer||0)>0;ce&&typeof oe.damageFlashTimer=="number"&&oe.damageFlashTimer--,e.save(),e.translate(c,p),a.includes("ARM")&&(e.shadowBlur=15,e.shadowColor=te,e.fillStyle=te,e.beginPath(),e.arc(0,0,7,0,Math.PI*2),e.fill()),e.rotate(J),e.fillStyle=ce?"#ff4444":te,e.beginPath(),e.roundRect(0,-A/2,P,A,6),e.fill(),e.restore()},N=Date.now()/120,_=Math.abs(n.vx)>.5?Math.sin(N)*.6:0,ne=n.onGround??!0?0:n.vy<0?-.4:.4,z=!n.limbs.LEFT_LEG.exists&&!n.limbs.RIGHT_LEG.exists?15:0;if(T(f.LEFT_LEG,r-8,S+z,25,10,Math.PI/2+_+ne,t),T(f.RIGHT_LEG,r+8,S+z,25,10,Math.PI/2-_+ne,t),e.save(),e.translate(r,S+z),!n.limbs.LEFT_LEG.exists&&n.limbs.RIGHT_LEG.exists?e.rotate(-.15):n.limbs.LEFT_LEG.exists&&!n.limbs.RIGHT_LEG.exists&&e.rotate(.15),e.translate(-r,-S-z+m),n.limbs[f.TORSO].exists){const a=n.limbs[f.TORSO].damageFlashTimer||0;typeof n.limbs[f.TORSO].damageFlashTimer=="number"&&a>0&&n.limbs[f.TORSO].damageFlashTimer--,e.shadowBlur=15,e.shadowColor=t,e.fillStyle=a>0?"#ff4444":t,e.beginPath(),e.arc(r,g,18,0,Math.PI*2),e.fill()}if(n.limbs[f.HEAD].exists){const a=n.limbs[f.HEAD].damageFlashTimer||0;typeof n.limbs[f.HEAD].damageFlashTimer=="number"&&a>0&&n.limbs[f.HEAD].damageFlashTimer--;const c=g-32+b;e.save(),e.translate(r,c+16),l&&d&&e.rotate(.1),e.translate(-r,-(c+16)),e.fillStyle=a>0?"#ff4444":t,e.beginPath(),e.roundRect(r-10,c,20,16,8),e.fill(),e.restore()}T(f.LEFT_ARM,r-15,g-7,28,12,n.facing,n.leftWeapon.color),T(f.RIGHT_ARM,r+15,g-7,28,12,n.facing,n.rightWeapon.color),e.restore(),d||(e.fillStyle=n.color,e.font="10px monospace",e.textAlign="center",e.fillText("P2",r,n.y-15))},Oe=e=>{const n=F.current,t=n.player;e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.translate(-n.camera.x,-n.camera.y),e.strokeStyle="#1a1a1a",e.lineWidth=1;const d=Math.floor(n.camera.x/100)*100,l=Math.floor(n.camera.y/100)*100;for(let r=d;r<d+e.canvas.width+100;r+=100)e.beginPath(),e.moveTo(r,l),e.lineTo(r,l+e.canvas.height+100),e.stroke();for(let r=l;r<l+e.canvas.height+100;r+=100)e.beginPath(),e.moveTo(d,r),e.lineTo(d+e.canvas.width+100,r),e.stroke();n.platforms.forEach(r=>{e.fillStyle=fe.PLATFORM,e.shadowBlur=15,e.shadowColor="black",e.fillRect(r.x,r.y,r.width,r.height)}),C.current.forEach(r=>{Ae(e,r,r.color,!1)}),Ae(e,t,B(),!0),n.enemies.forEach(r=>{e.save(),e.translate(r.x+r.width/2,r.y+r.height/2),e.rotate(r.vx*.05),e.fillStyle=fe.ENEMY,e.beginPath(),e.roundRect(-r.width/2,-r.height/2,r.width,r.height,8),e.fill(),e.restore()});const m=t.x+t.width/2,b=t.y+t.height/2;if(n.detachedLimbs.forEach(r=>{e.save(),e.translate(r.x+r.width/2,r.y+r.height/2),e.rotate(r.rotation),r.destroyed?(e.fillStyle=r.color+"66",e.globalAlpha=.6):(e.fillStyle=r.color,e.globalAlpha=1),e.shadowBlur=10,e.shadowColor=r.color,e.beginPath(),e.roundRect(-r.width/2,-r.height/2,r.width,r.height,6),e.fill(),e.restore();const g=r.x+r.width/2,S=r.y+r.height/2;if(Math.sqrt((m-g)**2+(b-S)**2)<80&&!r.destroyed){e.save(),e.translate(g,r.y-15);const N=Math.sin(Date.now()/200)*3;e.strokeStyle="#ffffff",e.lineWidth=2,e.shadowBlur=10,e.shadowColor="#ffffff",e.beginPath(),e.arc(0,0,8+N,0,Math.PI*2),e.stroke(),e.restore()}}),!n.star.collected){const r=n.star.x+10,g=n.star.y+10,S=Math.sin(Date.now()/150)*2;e.save(),e.translate(r,g),e.rotate(Date.now()/1e3),e.shadowBlur=20+S,e.shadowColor="#ffdd00",e.fillStyle="#ffdd00",e.beginPath();for(let T=0;T<5;T++){const N=T*4*Math.PI/5-Math.PI/2,_=15+S,Y=Math.cos(N)*_,ne=Math.sin(N)*_;T===0?e.moveTo(Y,ne):e.lineTo(Y,ne)}e.closePath(),e.fill(),e.restore()}n.projectiles.forEach(r=>{e.fillStyle=r.color,e.shadowBlur=10,e.shadowColor=r.color,e.beginPath(),e.arc(r.x+4,r.y+4,4,0,Math.PI*2),e.fill()}),n.vfx.forEach(r=>{e.globalAlpha=r.life/r.maxLife,e.fillStyle="white",e.shadowBlur=20,e.shadowColor=r.color,e.beginPath(),e.arc(r.x,r.y,r.size*(r.life/r.maxLife),0,Math.PI*2),e.fill()}),e.restore()};h.useEffect(()=>{const e=n=>{if(n.code==="Escape"||n.code==="KeyP"&&!n.repeat){const t=!o;y(),K&&(i!=null&&i.isConnected())&&i.send({type:"PAUSE_TOGGLE",playerId:v,data:{paused:t},timestamp:Date.now()})}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[y,o,K,i,v]),h.useEffect(()=>{const e=()=>{var t;De();const n=(t=H.current)==null?void 0:t.getContext("2d");n&&Oe(n),q.current=requestAnimationFrame(e)};return window.addEventListener("keydown",n=>{j.current[n.code]=!0}),window.addEventListener("keyup",n=>{j.current[n.code]=!1}),window.addEventListener("mousemove",n=>{X.current.x=n.clientX,X.current.y=n.clientY}),window.addEventListener("mousedown",n=>{n.button===0&&(X.current.left=!0),n.button===2&&(X.current.right=!0),Ge(n.button===0?"left":"right")}),window.addEventListener("mouseup",n=>{n.button===0&&(X.current.left=!1),n.button===2&&(X.current.right=!1)}),window.addEventListener("contextmenu",n=>n.preventDefault()),window.addEventListener("resize",()=>{H.current&&(H.current.width=window.innerWidth,H.current.height=window.innerHeight)}),q.current=requestAnimationFrame(e),()=>cancelAnimationFrame(q.current)},[]);const Ye=h.useCallback(()=>{const e=F.current,n=e.platforms[0],t=n.x+100+Math.random()*(n.width-200),d=n.y-100;e.player=xe(t,d),e.player.x=t,e.player.y=d,e.projectiles=[],e.vfx=[],e.gameOver=!1,e.camera={x:t-window.innerWidth/2,y:d-window.innerHeight/2},L({...e})},[]),Fe=h.useCallback(()=>{const e=F.current,n=e.platforms[0],t=n.x+100+Math.random()*(n.width-200),d=n.y-100;if(e.player=xe(t,d),e.player.x=t,e.player.y=d,e.enemies=[],e.projectiles=[],e.vfx=[],e.detachedLimbs=[],e.score=0,e.gameOver=!1,e.gameEnded=!1,e.gameStartTime=Date.now(),e.star=be(),e.camera={x:t-window.innerWidth/2,y:d-window.innerHeight/2},L({...e}),K&&i&&ee){const l=i.getPeerId();i.send({type:"GAME_START",playerId:l,data:{spawnX:t,spawnY:d},timestamp:Date.now()})}},[K,i,ee]);return s.jsxs(s.Fragment,{children:[s.jsx("canvas",{ref:H,width:window.innerWidth,height:window.innerHeight,className:"flex-grow"}),s.jsx($e,{state:Le,onRespawn:Ye,onNewGame:Fe,isPaused:o,globalPaused:u,isMultiplayer:K,isHost:ee,connectionStatus:k,onBackToMenu:E,onNameChange:R,localPlayerName:ae,localPlayerId:v,connectedPlayers:$,playerScores:ue.current})]})},Me=4;class Re{constructor(o,u,y="Player"){this.peer=null,this.connections=new Map,this.messageCallbacks=[],this.statusCallbacks=[],this.playerListCallbacks=[],this.currentStatus="disconnected",this.hostPeerId=null,this.connectedPlayers=new Map,this.isInitialized=!1,this.isHost=o,this.localPlayerId=u,this.localPlayerName=y}async initAsHost(){if(this.isInitialized)return console.log("[WebRTCManager] Already initialized as host"),this.getInviteLink(this.hostPeerId||"");this.isInitialized=!0,this.setStatus("connecting"),console.log("[WebRTCManager] Initializing as host..."),this.peer&&this.peer.destroy();const o=this.generateRoomId();return console.log("[WebRTCManager] Generated room ID:",o),this.peer=new Ie(o,{debug:1}),new Promise((u,y)=>{if(!this.peer)return;const w=setTimeout(()=>{console.error("[WebRTCManager] Host initialization timeout"),this.setStatus("error"),y(new Error("Host initialization timeout"))},15e3);this.peer.on("open",E=>{clearTimeout(w),console.log("[WebRTCManager] Host peer opened with ID:",E),this.hostPeerId=E,this.localPlayerId=E,this.addPlayer(this.localPlayerId,this.localPlayerName,Ee[0]),console.log("[WebRTCManager] Host added to player list"),this.peer.on("connection",R=>{console.log("[WebRTCManager] Host received connection event from:",R.peer),this.handleIncomingConnection(R)}),console.log("[WebRTCManager] Host ready, invite link:",this.getInviteLink(E)),u(this.getInviteLink(E))}),this.peer.on("error",E=>{clearTimeout(w),console.error("[WebRTCManager] Peer error:",E),console.error("[WebRTCManager] Error type:",E.type),this.setStatus("error"),y(E)})})}async joinAsGuest(o){if(this.isInitialized){console.log("[WebRTCManager] Already initialized, skipping joinAsGuest");return}return this.isInitialized=!0,this.setStatus("connecting"),this.hostPeerId=o,console.log("[WebRTCManager] Guest joining room:",o),this.peer&&this.peer.destroy(),this.peer=new Ie(void 0,{debug:1}),new Promise((u,y)=>{if(!this.peer)return;const w=setTimeout(()=>{console.error("[WebRTCManager] Connection timeout - peer did not open in 15 seconds"),this.setStatus("error"),y(new Error("Connection timeout"))},15e3);this.peer.on("open",R=>{clearTimeout(w),console.log("[WebRTCManager] Guest peer opened with ID:",R),console.log("[WebRTCManager] Attempting to connect to host:",o),this.localPlayerId=R;const i=this.peer.connect(o,{reliable:!1,serialization:"json"});if(!i){console.error("[WebRTCManager] Failed to create connection to host"),this.setStatus("error"),y(new Error("Failed to create connection"));return}console.log("[WebRTCManager] Connection object created, peer:",i.peer,"connection type:",i.serialization),i.on("open",()=>{console.log("[WebRTCManager] Connection OPEN event fired for host:",o)}),i.on("error",v=>{console.error("[WebRTCManager] Connection ERROR event:",v)}),i.on("close",()=>{console.log("[WebRTCManager] Connection CLOSE event fired")}),this.setupConnection(i)}),this.peer.on("error",R=>{clearTimeout(w),console.error("[WebRTCManager] Peer error:",R),console.error("[WebRTCManager] Error type:",R.type),console.error("[WebRTCManager] Error message:",R.message),this.setStatus("error"),y(R)});const E=R=>{console.log("[WebRTCManager] Status change:",R),R==="connected"?(this.offStatusChange(E),u()):R==="error"&&(this.offStatusChange(E),y(new Error("Connection failed")))};this.onStatusChange(E)})}handleIncomingConnection(o){const u=o.peer;if(console.log("[WebRTCManager] Incoming connection from:",u),console.log("[WebRTCManager] Current players:",this.connectedPlayers.size,"/",Me),this.connectedPlayers.size>=Me){console.log("[WebRTCManager] Room full, rejecting connection from:",u),o.close();return}o.on("error",y=>{console.error("[WebRTCManager] Incoming connection error from",u,y)}),this.setupConnection(o)}setupConnection(o){const u=o.peer;console.log("[WebRTCManager] Setting up connection with peer:",u,"isHost:",this.isHost),o.on("open",()=>{if(console.log("[WebRTCManager] Connection opened with:",u,"isHost:",this.isHost),this.connections.set(u,o),console.log("[WebRTCManager] Total connections:",this.connections.size),this.isHost){const y=this.connectedPlayers.size,w=`Player ${y+1}`,E=Ee[y%Ee.length];console.log("[WebRTCManager] Host: Adding guest",w,"with color",E),this.addPlayer(u,w,E),console.log("[WebRTCManager] Host: Sending GAME_STATE to new guest"),this.sendToPeer(u,{type:"GAME_STATE",playerId:this.localPlayerId,data:{players:Array.from(this.connectedPlayers.values())},timestamp:Date.now()}),console.log("[WebRTCManager] Host: Broadcasting PLAYER_JOINED to all"),this.broadcast({type:"PLAYER_JOINED",playerId:this.localPlayerId,data:{id:u,name:w,color:E},timestamp:Date.now()})}else console.log("[WebRTCManager] Guest: Sending PLAYER_NAME_CHANGE to host"),this.sendToPeer(this.hostPeerId,{type:"PLAYER_NAME_CHANGE",playerId:this.localPlayerId,data:{id:this.localPlayerId,name:this.localPlayerName},timestamp:Date.now()});console.log("[WebRTCManager] Updating connection status..."),this.updateConnectionStatus(),console.log("[WebRTCManager] New status:",this.currentStatus)}),o.on("data",y=>{try{const w=y;this.handleMessage(w,u)}catch(w){console.error("Failed to parse message:",w)}}),o.on("close",()=>{console.log("Connection closed with:",u),this.connections.delete(u),this.connectedPlayers.delete(u),this.notifyMessageListeners({type:"PLAYER_DISCONNECTED",playerId:u,data:{id:u},timestamp:Date.now()}),this.updateConnectionStatus()}),o.on("error",y=>{console.error("Connection error with",u,y)})}handleMessage(o,u){switch(console.log("[WebRTCManager] Message received:",o.type,"from:",u,"isHost:",this.isHost),o.type){case"PLAYER_JOINED":o.data&&o.data.id&&o.data.name&&this.addPlayer(o.data.id,o.data.name,o.data.color),this.isHost&&this.broadcastToOthers(u,o);break;case"GAME_STATE":o.data&&o.data.players&&(o.data.players.forEach(y=>{y.id!==this.localPlayerId&&this.connectedPlayers.set(y.id,y)}),this.notifyPlayerListListeners());break;case"PAUSE_TOGGLE":this.isHost&&this.broadcastToOthers(u,o);break;case"PLAYER_NAME_CHANGE":if(o.data&&o.data.id&&o.data.name){const y=this.connectedPlayers.get(o.data.id);y&&(this.connectedPlayers.set(o.data.id,{...y,name:o.data.name}),this.notifyPlayerListListeners())}this.isHost&&this.broadcastToOthers(u,o);break;case"GAME_START":console.log("[WebRTCManager] GAME_START received, isHost:",this.isHost,"localPlayerId:",this.localPlayerId),this.isHost&&(console.log("[WebRTCManager] Host broadcasting GAME_START to others"),this.broadcastToOthers(u,o)),console.log("[WebRTCManager] Notifying local listeners about GAME_START"),this.notifyMessageListeners(o);break;default:this.isHost&&this.broadcastToOthers(u,o);break}o.type!=="GAME_START"&&this.notifyMessageListeners(o)}addPlayer(o,u,y){this.connectedPlayers.set(o,{id:o,name:u,color:y}),this.notifyPlayerListListeners()}updateConnectionStatus(){const u=this.connections.size>0?"connected":this.peer&&this.peer.open?"connecting":"disconnected";this.setStatus(u)}sendToPeer(o,u){var w;const y=this.connections.get(o);y?y.open?y.send(u):console.warn("[WebRTCManager] Cannot send to",o,"- connection not open. State:",y.connectionState,"peer connection:",(w=y.peerConnection)==null?void 0:w.iceConnectionState):console.warn("[WebRTCManager] Cannot send to",o,"- no connection found. Available:",Array.from(this.connections.keys()))}broadcast(o){console.log("[WebRTCManager] Broadcasting",o.type,"to",this.connections.size,"connections"),this.connections.forEach(u=>{u.open?u.send(o):console.warn("[WebRTCManager] Cannot send to peer - connection not open:",u.peer)})}broadcastToOthers(o,u){console.log("[WebRTCManager] Broadcasting to others (excluding",o+")"),this.connections.forEach((y,w)=>{w!==o&&y.open&&y.send(u)})}send(o){console.log("[WebRTCManager] Sending",o.type,"isHost:",this.isHost,"hostPeerId:",this.hostPeerId),this.isHost?this.broadcast(o):this.hostPeerId?this.sendToPeer(this.hostPeerId,o):console.warn("[WebRTCManager] Cannot send - not host and no hostPeerId")}onMessage(o){this.messageCallbacks.push(o)}offMessage(o){this.messageCallbacks=this.messageCallbacks.filter(u=>u!==o)}onStatusChange(o){this.statusCallbacks.push(o),o(this.currentStatus)}offStatusChange(o){this.statusCallbacks=this.statusCallbacks.filter(u=>u!==o)}onPlayerListChange(o){this.playerListCallbacks.push(o),o(Array.from(this.connectedPlayers.values()))}setStatus(o){this.currentStatus=o,this.statusCallbacks.forEach(u=>u(o))}notifyMessageListeners(o){this.messageCallbacks.forEach(u=>u(o))}notifyPlayerListListeners(){const o=Array.from(this.connectedPlayers.values());this.playerListCallbacks.forEach(u=>u(o))}getStatus(){return this.currentStatus}getConnectedPlayers(){return Array.from(this.connectedPlayers.values())}getPlayerCount(){return this.connectedPlayers.size}canAcceptMorePlayers(){return this.connectedPlayers.size<Me}getInviteLink(o){const u=new URL(window.location.href);return u.searchParams.set("room",o),u.toString()}static getRoomIdFromURL(){return new URL(window.location.href).searchParams.get("room")}static clearRoomFromURL(){const o=new URL(window.location.href);o.searchParams.delete("room"),window.history.replaceState({},"",o.toString())}generateRoomId(){return`robo_${Math.random().toString(36).substr(2,9)}`}getHostPeerId(){return this.hostPeerId}setPlayerName(o){this.localPlayerName=o,this.connectedPlayers.has(this.localPlayerId)&&(this.connectedPlayers.set(this.localPlayerId,{id:this.localPlayerId,name:o,color:Ee[0]}),this.notifyPlayerListListeners()),this.isHost?this.broadcast({type:"PLAYER_NAME_CHANGE",playerId:this.localPlayerId,data:{id:this.localPlayerId,name:o},timestamp:Date.now()}):this.send({type:"PLAYER_NAME_CHANGE",playerId:this.localPlayerId,data:{id:this.localPlayerId,name:o},timestamp:Date.now()})}getLocalPlayerName(){return this.localPlayerName}getPeerId(){return this.localPlayerId}close(){this.connections.forEach(o=>o.close()),this.connections.clear(),this.peer&&(this.peer.destroy(),this.peer=null),this.connectedPlayers.clear(),this.isInitialized=!1,this.setStatus("disconnected")}isConnected(){return this.currentStatus==="connected"&&this.connections.size>0}isHostMode(){return this.isHost}}function je(){return`player_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Ke=({onSubmit:G,isHost:o,defaultName:u,initializing:y=!1})=>{const[w,E]=h.useState(u);h.useEffect(()=>{const v=sessionStorage.getItem("altJoinCode");if(v&&!o)try{JSON.parse(v).hostId}catch{}},[o]);const R=()=>{const v=w.trim()||"Player";G(v)},i=v=>{v.key==="Enter"&&R()};return s.jsx("div",{className:"fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-[#1a1a1a] border border-cyan-500/30 rounded-2xl p-10 max-w-md w-full mx-4 text-center",children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("div",{className:"w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center",children:s.jsx("span",{className:"text-4xl",children:"ðŸ¤–"})}),s.jsx("h2",{className:"text-3xl font-bold text-white uppercase tracking-widest mb-2",children:o?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹":"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ"}),s.jsx("p",{className:"text-gray-400",children:o?"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº Ð¸Ð³Ñ€Ðµ"})]}),s.jsx("input",{type:"text",value:w,onChange:v=>E(v.target.value.slice(0,15)),onKeyPress:i,placeholder:"Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ",maxLength:15,className:"w-full px-6 py-4 bg-black/50 border-2 border-cyan-500/30 rounded-lg text-white text-center text-xl font-mono focus:border-cyan-500 focus:outline-none transition-colors",autoFocus:!0}),s.jsxs("div",{className:"mt-4 text-gray-500 text-sm",children:[w.length,"/15 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"]}),s.jsx("div",{className:"flex gap-4 mt-8",children:s.jsx("button",{onClick:R,disabled:y,className:"flex-1 px-8 py-4 bg-cyan-500 text-black font-bold uppercase tracking-widest rounded-lg hover:bg-cyan-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:y?"â³ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...":o?"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ":"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"})}),s.jsx("div",{className:"mt-6 p-4 bg-cyan-500/10 border border-cyan-500/20 rounded-lg",children:s.jsxs("p",{className:"text-cyan-400 text-xs",children:[s.jsx("strong",{className:"block mb-1",children:"â„¹ï¸ Info:"}),o?"ÐŸÐ¾ÑÐ»Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ Ð²Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ·ÐµÐ¹.":"Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð´Ñ‘Ñ‚Ðµ Ð² Ð»Ð¾Ð±Ð±Ð¸ Ñ…Ð¾ÑÑ‚Ð° Ð¸ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ Ð²Ð¼ÐµÑÑ‚Ðµ."]})})]})})},Be=({onClose:G,onJoinClick:o})=>s.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-[#1a1a1a] border border-white/10 rounded-xl p-8 max-w-md w-full mx-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold text-white uppercase tracking-widest",children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"}),s.jsx("button",{onClick:G,className:"text-gray-400 hover:text-white transition-colors text-2xl",children:"âœ•"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"bg-orange-500/10 border border-orange-500/30 rounded-lg p-4",children:[s.jsx("h3",{className:"text-orange-400 font-bold uppercase tracking-wider mb-2",children:"ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ"}),s.jsx("p",{className:"text-gray-400 text-sm mb-4",children:"Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ Ð¼ÐµÑ‚Ð¾Ð´, ÐµÑÐ»Ð¸ ÑÑÑ‹Ð»ÐºÐ°-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚. Ð’Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¾Ð±Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ ÐºÐ¾Ð´Ð°Ð¼Ð¸ Ñ Ñ…Ð¾ÑÑ‚Ð¾Ð¼."}),s.jsx("button",{onClick:o,className:"w-full px-6 py-3 bg-orange-500 text-black font-bold uppercase tracking-wider rounded-lg hover:bg-orange-400 transition-colors",children:"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð¿Ð¾ ÐºÐ¾Ð´Ñƒ"})]}),s.jsx("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4",children:s.jsxs("p",{className:"text-blue-300 text-xs",children:[s.jsx("strong",{className:"block mb-1",children:"â„¹ï¸ Ðž Ð¼ÐµÑ‚Ð¾Ð´Ð°Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"}),"â€¢ ",s.jsx("strong",{children:"ÐŸÐ¾ ÑÑÑ‹Ð»ÐºÐµ"})," â€” Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð° Ð³Ð»Ð°Ð²Ð½Ð¾Ð¼ Ð¼ÐµÐ½ÑŽ Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ",s.jsx("br",{}),"â€¢ ",s.jsx("strong",{children:"ÐŸÐ¾ ÐºÐ¾Ð´Ñƒ"})," â€” Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ PeerJS ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"]})})]})]})}),qe=({onStartGame:G})=>{const[o,u]=h.useState(!1),[y,w]=h.useState(!1),[E,R]=h.useState(""),[i,v]=h.useState([]),[ae,H]=h.useState(!1),[q,j]=h.useState(!1),[me,X]=h.useState(!1),[C,k]=h.useState(!1),[V,$]=h.useState("Player"),D=ke.useRef(null),[Z,se]=h.useState(!1),[ve,le]=h.useState(!1),[de,he]=h.useState(!1),[pe,ue]=h.useState(V),[K,ee]=h.useState(""),B=h.useMemo(()=>je(),[]);h.useEffect(()=>{Re.getRoomIdFromURL()&&k(!0)},[]);const ye=h.useCallback(async()=>{if(Z||q)return;se(!0),D.current&&D.current.close();const x="Player";$(x);const M=new Re(!0,B,x);D.current=M;try{const W=await M.initAsHost();R(W),j(!0),ee(M.getPeerId()),await navigator.clipboard.writeText(W),le(!0),setTimeout(()=>le(!1),3e3),M.onPlayerListChange(U=>{v(U),H(U.length>=1)}),v(M.getConnectedPlayers())}catch(W){console.error("Failed to init host:",W),se(!1)}finally{se(!1)}},[Z,q,B]),Te=h.useCallback(async x=>{if(Z)return;se(!0),D.current&&D.current.close(),$(x);const M=new Re(!1,B,x);D.current=M;let W=Re.getRoomIdFromURL();if(!W){const U=sessionStorage.getItem("altJoinCode");U&&(W=U,sessionStorage.removeItem("altJoinCode"))}if(!W){u(!0),se(!1);return}try{await M.joinAsGuest(W),Re.clearRoomFromURL(),ee(M.getPeerId()),M.onPlayerListChange(U=>{v(U)}),M.onMessage(U=>{console.log("[MainMenu Guest] Received message:",U.type,U),U.type==="GAME_START"&&(console.log("[MainMenu Guest] GAME_START received! Starting game..."),X(!1),G(ie.MULTI_PLAYER,M))}),v(M.getConnectedPlayers()),X(!0),k(!1)}catch(U){console.error("Failed to join game:",U),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¾Ð½Ð° Ð¿ÐµÑ€ÐµÐ¿Ð¾Ð»Ð½ÐµÐ½Ð° Ð¸Ð»Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°."),Re.clearRoomFromURL(),se(!1)}finally{se(!1)}},[Z,B,G]),be=async()=>{E&&(await navigator.clipboard.writeText(E),le(!0),setTimeout(()=>le(!1),3e3))},F=()=>{const x=pe.trim()||"Player";$(x),he(!1),D.current&&D.current.setPlayerName(x)},Le=()=>{ue(V),he(!0)},L=()=>{var M;const x=D.current;if(x){console.log("[MainMenu] Host starting game, peerId:",K||B);const W=-400+Math.random()*2800,ge={type:"GAME_START",playerId:K||B,data:{spawnX:W,spawnY:400},timestamp:Date.now()};console.log("[MainMenu] Sending GAME_START message FIRST:",ge),x.send(ge),console.log("[MainMenu] GAME_START sent, connections:",((M=x.connections)==null?void 0:M.size)||"unknown"),setTimeout(()=>{console.log("[MainMenu] Now calling onStartGame"),G(ie.MULTI_PLAYER,x)},50)}else console.error("[MainMenu] Cannot start game - manager is null!")},O=()=>{G(ie.SINGLE_PLAYER)};return C?s.jsx(Ke,{onSubmit:Te,isHost:!1,defaultName:V,initializing:Z}):s.jsxs("div",{className:"fixed inset-0 bg-[#0a0a0a] flex items-center justify-center",children:[s.jsx("div",{className:"absolute inset-0 opacity-20",children:s.jsx("div",{className:"absolute inset-0",style:{backgroundImage:`
            linear-gradient(rgba(0, 242, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 242, 255, 0.1) 1px, transparent 1px)
          `,backgroundSize:"50px 50px",animation:"grid-move 20s linear infinite"}})}),s.jsx("style",{children:`
        @keyframes grid-move {
          0% { transform: translate(0, 0); }
          100% { transform: translate(50px, 50px); }
        }
        @keyframes pulse-glow {
          0%, 100% { box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); }
          50% { box-shadow: 0 0 40px rgba(0, 242, 255, 0.6); }
        }
        @keyframes title-glow {
          0%, 100% { text-shadow: 0 0 20px rgba(0, 242, 255, 0.5), 0 0 40px rgba(0, 242, 255, 0.3); }
          50% { text-shadow: 0 0 40px rgba(0, 242, 255, 0.8), 0 0 80px rgba(0, 242, 255, 0.5); }
        }
        .menu-btn {
          animation: pulse-glow 3s ease-in-out infinite;
        }
        .menu-btn:hover {
          animation: none;
          box-shadow: 0 0 50px rgba(0, 242, 255, 0.8) !important;
        }
      `}),s.jsxs("div",{className:"relative z-10 flex gap-8 items-center",children:[s.jsxs("div",{className:"text-center",children:[s.jsxs("div",{className:"mb-8",children:[s.jsx("h1",{className:"text-6xl font-black italic tracking-tighter text-white mb-2",style:{animation:"title-glow 3s ease-in-out infinite"},children:"ROBO-DISMANTLE"}),s.jsx("p",{className:"text-xl font-bold text-cyan-400 tracking-[0.5em] uppercase",children:"Neon Protocol"})]}),s.jsx("div",{className:"flex flex-col gap-3 items-center",children:me?s.jsxs(s.Fragment,{children:[s.jsx("button",{disabled:!0,className:"w-64 px-6 py-3 bg-cyan-500/10 border-2 border-cyan-500/30 rounded-lg text-white/50 font-bold uppercase tracking-widest cursor-not-allowed",children:"ÐžÐ´Ð¸Ð½Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð³Ñ€Ð°"}),s.jsxs("div",{className:"w-64 px-6 py-3 bg-orange-500/10 border-2 border-orange-500/30 rounded-lg text-center",children:[s.jsx("p",{className:"text-orange-400 font-bold uppercase text-sm",children:"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ñ…Ð¾ÑÑ‚Ð°..."}),s.jsx("p",{className:"text-gray-500 text-xs mt-1",children:'Ð˜Ð³Ñ€Ð° Ð½Ð°Ñ‡Ð½Ñ‘Ñ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° Ñ…Ð¾ÑÑ‚ Ð½Ð°Ð¶Ð¼Ñ‘Ñ‚ "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ"'})]}),s.jsx("button",{disabled:!0,className:"w-64 px-6 py-3 bg-white/5 border-2 border-white/10 rounded-lg text-white/50 font-bold uppercase tracking-widest cursor-not-allowed",children:"âš™ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"}),s.jsx("button",{onClick:()=>{var x;(x=D.current)==null||x.close(),X(!1),v([])},className:"w-64 px-6 py-3 bg-red-500/10 border-2 border-red-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-red-500 hover:text-black transition-all duration-300",children:"âœ• ÐŸÐ¾ÐºÐ¸Ð½ÑƒÑ‚ÑŒ Ð»Ð¾Ð±Ð±Ð¸"})]}):s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:O,disabled:q,className:"menu-btn w-64 px-6 py-3 bg-cyan-500/10 border-2 border-cyan-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-cyan-500 hover:text-black transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed",children:"ÐžÐ´Ð¸Ð½Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð³Ñ€Ð°"}),q?s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:be,className:"menu-btn w-64 px-6 py-3 bg-green-500/10 border-2 border-green-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-green-500 hover:text-black transition-all duration-300",style:{animationDelay:"0.2s"},children:ve?"âœ“ Ð¡ÑÑ‹Ð»ÐºÐ° ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°!":"ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ"}),ae&&s.jsx("button",{onClick:L,className:"menu-btn w-64 px-6 py-3 bg-yellow-500/10 border-2 border-yellow-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-yellow-500 hover:text-black transition-all duration-300 animate-pulse",style:{animationDelay:"0.3s"},children:"â–¶ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ"}),s.jsx("button",{onClick:()=>{var x;(x=D.current)==null||x.close(),j(!1),R(""),v([]),H(!1)},className:"w-64 px-6 py-3 bg-red-500/10 border-2 border-red-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-red-500 hover:text-black transition-all duration-300",children:"âœ• ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})]}):s.jsx("button",{onClick:ye,disabled:Z,className:"menu-btn w-64 px-6 py-3 bg-green-500/10 border-2 border-green-500/50 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-green-500 hover:text-black transition-all duration-300",style:{animationDelay:"0.2s"},children:Z?"â³ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹...":"ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ"}),s.jsx("button",{onClick:()=>w(!0),disabled:q,className:"menu-btn w-64 px-6 py-3 bg-white/5 border-2 border-white/20 rounded-lg text-white font-bold uppercase tracking-widest hover:bg-white/10 transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed",style:{animationDelay:"0.4s"},children:"âš™ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"})]})}),s.jsxs("div",{className:"mt-6 text-gray-500 text-xs",children:[s.jsx("p",{className:"mb-1 uppercase tracking-widest",children:"Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ"}),s.jsx("p",{children:"WASD â€” Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ | Space â€” Ð¿Ñ€Ñ‹Ð¶Ð¾Ðº | Ð›ÐšÐœ/ÐŸÐšÐœ â€” ÑÑ‚Ñ€ÐµÐ»ÑŒÐ±Ð°"}),s.jsx("p",{children:"ESC/P â€” Ð¿Ð°ÑƒÐ·Ð°"})]})]}),s.jsxs("div",{className:"w-72 bg-[#1a1a1a] border border-cyan-500/30 rounded-xl p-6",children:[s.jsxs("h3",{className:"text-cyan-400 text-sm font-black uppercase tracking-widest mb-4 border-b border-cyan-500/30 pb-2",children:["Ð›Ð¾Ð±Ð±Ð¸ (",i.length,"/4)"]}),s.jsxs("div",{className:"space-y-3",children:[i.map(x=>{var ge;const M=((ge=D.current)==null?void 0:ge.getPeerId())||B,W=x.id===M,U=de&&W;return s.jsxs("div",{className:"flex items-center gap-3 bg-black/30 rounded-lg p-3 border border-white/10",children:[s.jsx("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:x.color,boxShadow:`0 0 10px ${x.color}`}}),U?s.jsx("input",{type:"text",value:pe,onChange:we=>ue(we.target.value.slice(0,15)),onKeyDown:we=>{we.key==="Enter"&&F(),we.key==="Escape"&&(ue(V),he(!1))},onBlur:F,className:"flex-1 bg-white/10 border border-cyan-500/50 rounded px-2 py-1 text-white text-sm font-mono focus:outline-none focus:border-cyan-500",autoFocus:!0,maxLength:15}):s.jsx("span",{className:"text-white font-mono text-sm flex-1",children:x.name}),W&&!U&&s.jsx("button",{onClick:Le,className:"text-gray-400 hover:text-cyan-400 transition-colors text-xs",title:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¸Ð¼Ñ",children:"âœï¸"}),W&&!U&&s.jsx("span",{className:"text-[10px] text-gray-500 uppercase",children:"(Ð²Ñ‹)"})]},x.id)}),i.length===0&&s.jsx("p",{className:"text-gray-500 text-sm text-center py-4",children:me?"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ñ…Ð¾ÑÑ‚Ñƒ...":q?"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²...":'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Ð¡ÑÑ‹Ð»ÐºÐ°-Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ" Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ'})]}),q&&E&&s.jsxs("div",{className:"mt-4 p-3 bg-black/30 rounded-lg border border-white/10",children:[s.jsx("p",{className:"text-[10px] text-gray-500 uppercase mb-1",children:"Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ:"}),s.jsxs("p",{className:"text-[10px] text-cyan-400 font-mono break-all",children:[E.slice(0,40),"..."]})]})]})]}),y&&s.jsx(Be,{onClose:()=>w(!1),onJoinClick:()=>{w(!1),j(!1),u(!0)}}),o&&!C&&s.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-[#1a1a1a] border border-white/10 rounded-xl p-8 max-w-2xl w-full mx-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold text-white uppercase tracking-widest",children:"ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ"}),s.jsx("button",{onClick:()=>u(!1),className:"text-gray-400 hover:text-white transition-colors text-2xl",children:"âœ•"})]}),s.jsx("p",{className:"text-gray-400 mb-6",children:"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ Ð¾Ñ‚ Ñ…Ð¾ÑÑ‚Ð°:"}),s.jsx("textarea",{id:"altJoinInput",className:"w-full h-32 bg-black/50 border border-white/10 rounded-lg p-3 text-white text-xs font-mono resize-none focus:border-orange-500 focus:outline-none mb-4",placeholder:"Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÑŽÐ´Ð° ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ..."}),s.jsxs("div",{className:"flex gap-4",children:[s.jsx("button",{onClick:()=>{var M;const x=(M=document.getElementById("altJoinInput"))==null?void 0:M.value;x&&(u(!1),j(!1),sessionStorage.setItem("altJoinCode",x),k(!0))},className:"flex-1 px-6 py-3 bg-orange-500 text-black font-bold uppercase tracking-wider rounded-lg hover:bg-orange-400 transition-colors",children:"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"}),s.jsx("button",{onClick:()=>u(!1),className:"px-6 py-3 bg-white/10 text-white font-bold uppercase tracking-wider rounded-lg hover:bg-white/20 transition-colors",children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})]})})]})},Ve=()=>{const[G,o]=h.useState(ie.MENU),[u,y]=h.useState(!1),[w,E]=h.useState(!1),R=h.useRef(null),i=h.useRef(je()),v=h.useRef("Player"),ae=h.useCallback((C,k)=>{if(console.log("[App] handleStartGame called, mode:",C,"hasManager:",!!k),o(C),y(!1),E(!1),k){R.current=k,v.current=k.getLocalPlayerName();const V=k.getPeerId();i.current=V,console.log("[App] Game started, realPeerId:",V),k.onMessage($=>{console.log("[App] Message received in game:",$.type),$.type==="PAUSE_TOGGLE"?E($.data.paused):$.type})}},[]),H=h.useCallback(()=>{var k;if(G===ie.MENU)return;const C=(k=R.current)==null?void 0:k.isHostMode();(G===ie.SINGLE_PLAYER||G===ie.MULTI_PLAYER||C)&&y(V=>{const $=!V;if(E($),C&&R.current){const D=R.current.getPeerId();R.current.send({type:"PAUSE_TOGGLE",playerId:D,data:{paused:$},timestamp:Date.now()})}return $})},[G]),q=h.useCallback(C=>{var k;v.current=C,(k=R.current)==null||k.setPlayerName(C)},[]),j=h.useCallback(()=>{y(!1),E(!1)},[]),me=h.useCallback(()=>{var C;o(ie.MENU),y(!1),E(!1),(C=R.current)==null||C.close(),R.current=null},[]);h.useEffect(()=>()=>{var C;(C=R.current)==null||C.close()},[]);const X=u||w;return s.jsx("div",{id:"game-container",className:"bg-[#0a0a0a] h-screen w-screen overflow-hidden flex flex-col",children:G===ie.MENU?s.jsx(qe,{onStartGame:ae}):s.jsxs(s.Fragment,{children:[s.jsx(Je,{gameMode:G,isPaused:X,globalPaused:w,onPauseToggle:H,onRestart:j,onBackToMenu:me,onNameChange:q,webrtcManager:R.current,localPlayerId:i.current,localPlayerName:v.current}),s.jsx("div",{className:"absolute bottom-4 right-4 text-white/30 text-[10px] uppercase tracking-widest pointer-events-none",children:"WASD to Move | Space: Jump | ESC/P: Pause"})]})})},_e=document.getElementById("root");if(!_e)throw new Error("Could not find root element to mount to");const Ze=We.createRoot(_e);Ze.render(s.jsx(ke.StrictMode,{children:s.jsx(Ve,{})}));
